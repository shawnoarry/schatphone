# SchatPhone 聊天功能推进文档

更新时间：2026-02-11  
负责人：当前仓库主线（Vue 3 + Pinia + Vite）

## 1. 结论先行（当前到哪一步）

聊天功能目前是 **可用的 Beta 底座**，不是纯原型了。

已完成的核心能力：
- 数据模型升级为会话+消息分离（`conversations` + `messagesByConversation`）。
- 消息状态完整链路（`sending` / `sent` / `failed`）。
- 发送管线统一（队列、失败中止、重试、取消请求）。
- 草稿/未读/会话排序已打通（列表可展示）。
- 兼容旧数据迁移（老 `chatHistory` 自动迁移）。
- 基础测试已补（store 模型 + 错误映射）。

当前可给到的完成度评估：**Chat 88%（工程底座层）**。

---

## 2. 已落地能力（对应代码）

### 2.1 数据模型（V2）
- 版本：`CHAT_STORAGE_VERSION = 2`
- 新结构：
  - 会话：`conversations`（draft / unread / lastMessage / updatedAt / pinned）
  - 消息：`messagesByConversation`（id / createdAt / status / role / content）
- 关键文件：`src/stores/chat.js`

### 2.2 发送管线
- 队列处理：同会话按顺序发送，避免上下文乱序。
- 失败处理：当前失败后中止后续队列并标失败。
- 重试处理：失败消息可重试，继续走同一管线。
- 取消处理：支持 AbortController 取消当前请求并清队列。
- 关键文件：`src/views/ChatView.vue`, `src/lib/ai.js`

### 2.3 会话体验
- 草稿：输入实时保存，切换会话恢复。
- 未读：非当前会话收到 AI 回复会累加未读。
- 列表：按置顶（预留）+ 更新时间排序，支持草稿与未读展示。
- 关键文件：`src/views/ChatView.vue`, `src/stores/chat.js`

### 2.4 稳定性和测试
- 取消错误码：`CANCELED` -> UI 显示“请求已取消”。
- 测试文件：
  - `tests/chat-store-model.test.js`
  - `tests/ai-error-format.test.js`

---

## 3. 当前未完成/待办（按优先级）

## P0（下一步建议先做）
1. **会话管理 UI 补齐**
   - 置顶、会话删除、标记未读/已读入口。
2. **发送管线可观测性**
   - 队列长度、当前任务、失败原因结构化展示（不仅仅是文案）。
3. **失败重试策略细化**
   - 区分“仅重发用户消息”与“重拉 AI 回复”两类重试。
4. **备份恢复闭环**
   - 导入时支持 V1/V2 聊天数据自动兼容和校验。

## P1
1. **流式输出（Streaming）**
   - assistant 回复逐字/分段渲染，状态新增 `streaming`。
2. **会话检索与标签**
   - 搜索联系人/消息片段，标签与过滤器。
3. **消息操作**
   - 单条删除、复制、引用回复、失败消息批量处理。

## P2
1. **多端同步策略（预留）**
   - 本地版本冲突策略、服务端时间戳合并规则。
2. **性能优化**
   - 长会话分页加载、虚拟列表。

---

## 4. 推荐执行顺序（短周期）

### Sprint A（1~2 天）
- 会话管理 UI：置顶/删除/已读操作。
- 备份导入校验（V1/V2 兼容）。

### Sprint B（2~3 天）
- 发送管线监控面板（简化版）。
- 失败重试策略拆分（消息级重试 vs 会话级重试）。

### Sprint C（3~5 天）
- 流式回复 MVP（OpenAI-compatible 先行）。

---

## 5. 验收标准（聊天专用）

达到以下标准，聊天可进入“可扩展稳定版本”：
- 任意会话连续发送 20 条消息，无乱序、无状态错乱。
- 网络异常/超时/取消三类场景都可恢复，不产生脏队列。
- 草稿、未读、排序在刷新后保持一致。
- V1 老数据升级到 V2 不丢历史消息。
- `npm run lint` / `npm run test` / `npm run build` 全绿。

---

## 6. 当前已知风险

- 当前仍是本地持久化为主，未接入服务端同步；跨设备一致性暂未覆盖。
- `pinned` 字段已有，但 UI 操作还未开放，属于“数据先行，交互待补”。
- 发送管线已统一，但还缺“结构化监控视图”，调试依赖日志。
